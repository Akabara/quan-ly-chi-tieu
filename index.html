<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Thu Chi C√° Nh√¢n</title>
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to complement Tailwind CSS */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animation for modals and pop-ups */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Styling for the AI feedback pop-up */
        .ai-feedback {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }
        
        .btn-action {
            @apply p-1 rounded-md transition-colors;
        }
        .btn-edit {
             @apply text-blue-500 hover:bg-blue-100;
        }
        .btn-delete {
            @apply text-red-500 hover:bg-red-100;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-6 max-w-4xl">

        <!-- Header -->
        <header class="text-center text-white mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i!</h1>
            <p class="text-lg opacity-90">H√£y c√πng qu·∫£n l√Ω t√†i ch√≠nh th·∫≠t hi·ªáu qu·∫£ nh√©.</p>
            <p id="user-id-display" class="text-xs mt-2 opacity-70 break-all"></p>
        </header>

        <!-- Account Cards -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
            <div class="account-card bg-white/20 backdrop-blur-lg rounded-2xl p-5 text-white shadow-lg">
                <h3 class="text-xl font-semibold mb-2 flex items-center gap-2">üíµ Ti·ªÅn m·∫∑t</h3>
                <p id="cash-balance" class="text-3xl font-bold">0ƒë</p>
            </div>
            <div class="account-card bg-white/20 backdrop-blur-lg rounded-2xl p-5 text-white shadow-lg">
                <h3 class="text-xl font-semibold mb-2 flex items-center gap-2">üí≥ Ng√¢n h√†ng</h3>
                <p id="bank-balance" class="text-3xl font-bold">0ƒë</p>
            </div>
        </section>

        <!-- Transaction Input Form -->
        <section class="bg-white/90 backdrop-blur-lg rounded-2xl p-5 md:p-6 mb-6 shadow-xl">
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="transaction-input" placeholder="VD: ƒÇn t·ªëi 50k ho·∫∑c d√πng micro..." class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:outline-none transition">
                <button id="voice-btn" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                </button>
                <button id="add-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition shadow-md">Th√™m</button>
            </div>
            <div id="ai-status" class="mt-3 text-center text-indigo-700 font-medium hidden">
                <div class="flex items-center justify-center gap-2">
                    <svg class="animate-spin h-5 w-5 text-indigo-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ü§ñ AI ƒëang ph√¢n t√≠ch...
                </div>
            </div>
        </section>

        <!-- Transactions List -->
        <section class="bg-white/90 backdrop-blur-lg rounded-2xl p-5 md:p-6 shadow-xl">
            <h2 class="text-2xl font-bold mb-4">L·ªãch s·ª≠ giao d·ªãch</h2>

            <!-- Filter Section -->
            <div class="filter-section grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                 <div>
                    <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">L·ªçc theo ng√†y</label>
                    <input type="date" id="date-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="month-filter" class="block text-sm font-medium text-gray-700 mb-1">L·ªçc theo th√°ng</label>
                    <input type="month" id="month-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div class="self-end">
                    <button id="clear-filter-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">X√≥a b·ªô l·ªçc</button>
                </div>
            </div>

            <div class="transactions-container min-h-[200px]" id="transactions-container">
                <p class="text-gray-500 text-center py-8" id="no-transactions">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>
            </div>

            <!-- Pagination Section -->
            <div id="pagination-controls" class="flex justify-between items-center mt-6">
                <button id="prev-page-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:bg-gray-300 transition">‚Üê Tr∆∞·ªõc</button>
                <span id="page-info" class="font-medium">Trang 1 / 1</span>
                <button id="next-page-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:bg-gray-300 transition">Sau ‚Üí</button>
            </div>
        </section>

    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <!-- AI Feedback Container -->
    <div id="ai-feedback-container"></div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCDgB8CVTNA7Sb922z7vFhVE5jYFq0p_Wk",
            authDomain: "quan-ly-chi-tieu-3684e.firebaseapp.com",
            projectId: "quan-ly-chi-tieu-3684e",
            storageBucket: "quan-ly-chi-tieu-3684e.firebasestorage.app",
            messagingSenderId: "966188691810",
            appId: "1:966188691810:web:c65c3490c6fa32cad53c3b"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;

        // --- DOM Elements ---
        const transactionInput = document.getElementById('transaction-input');
        const addBtn = document.getElementById('add-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const aiStatus = document.getElementById('ai-status');
        const transactionsContainer = document.getElementById('transactions-container');
        const noTransactionsMsg = document.getElementById('no-transactions');
        const cashBalanceEl = document.getElementById('cash-balance');
        const bankBalanceEl = document.getElementById('bank-balance');
        const userIdDisplay = document.getElementById('user-id-display');
        const dateFilter = document.getElementById('date-filter');
        const monthFilter = document.getElementById('month-filter');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');
        const paginationControls = document.getElementById('pagination-controls');


        // --- Main App Logic ---
        class FinanceApp {
            constructor() {
                this.transactionManager = new TransactionManager(this);
                this.voiceManager = new VoiceInputManager();
                this.allTransactions = [];
                this.currentPage = 1;
                this.transactionsPerPage = 15;
                this.filters = { date: '', month: '' };
                this.initEventListeners();
            }

            initEventListeners() {
                addBtn.addEventListener('click', () => this.processNewTransaction());
                transactionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.processNewTransaction();
                });
                voiceBtn.addEventListener('click', () => this.startVoiceInput());
                
                // Filter listeners
                dateFilter.addEventListener('change', () => this.applyDateFilter());
                monthFilter.addEventListener('change', () => this.applyMonthFilter());
                clearFilterBtn.addEventListener('click', () => this.clearFilters());

                // Pagination listeners
                prevPageBtn.addEventListener('click', () => this.changePage(-1));
                nextPageBtn.addEventListener('click', () => this.changePage(1));
            }
            
            applyDateFilter() {
                this.filters.date = dateFilter.value;
                this.filters.month = '';
                monthFilter.value = '';
                this.currentPage = 1;
                this.renderDisplay();
            }

            applyMonthFilter() {
                this.filters.month = monthFilter.value;
                this.filters.date = '';
                dateFilter.value = '';
                this.currentPage = 1;
                this.renderDisplay();
            }

            clearFilters() {
                this.filters.date = '';
                this.filters.month = '';
                dateFilter.value = '';
                monthFilter.value = '';
                this.currentPage = 1;
                this.renderDisplay();
            }
            
            changePage(direction) {
                this.currentPage += direction;
                this.renderDisplay();
            }

            async processNewTransaction() {
                const userInput = transactionInput.value.trim();
                if (!userInput) {
                    this.showError("Vui l√≤ng nh·∫≠p th√¥ng tin giao d·ªãch.");
                    return;
                }
                
                addBtn.disabled = true;
                aiStatus.classList.remove('hidden');

                try {
                    await this.transactionManager.processUserInput(userInput);
                    transactionInput.value = '';
                } catch (error) {
                    console.error("Error processing transaction:", error);
                    this.showError(error.message || "ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.");
                } finally {
                    addBtn.disabled = false;
                    aiStatus.classList.add('hidden');
                }
            }

            async startVoiceInput() {
                voiceBtn.classList.add('animate-pulse');
                try {
                    const transcript = await this.voiceManager.startListening();
                    transactionInput.value = transcript;
                    this.processNewTransaction();
                } catch (error) {
                    console.error('Voice recognition error:', error);
                    this.showError("Kh√¥ng th·ªÉ nh·∫≠n d·∫°ng gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.");
                } finally {
                    voiceBtn.classList.remove('animate-pulse');
                }
            }
            
            showConfirmation(message) {
                return new Promise((resolve) => {
                    const modalContainer = document.getElementById('modal-container');
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    
                    modal.innerHTML = `
                        <div class="modal-fade-in bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
                            <p class="text-lg mb-6">${message}</p>
                            <div class="flex justify-center gap-4">
                                <button id="confirm-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">H·ªßy</button>
                                <button id="confirm-ok" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">X√°c nh·∫≠n</button>
                            </div>
                        </div>
                    `;
                    modalContainer.innerHTML = ''; // Clear any previous modals
                    modalContainer.appendChild(modal);

                    const closeModal = () => modalContainer.innerHTML = '';

                    document.getElementById('confirm-ok').onclick = () => {
                        closeModal();
                        resolve(true);
                    };

                    document.getElementById('confirm-cancel').onclick = () => {
                        closeModal();
                        resolve(false);
                    };
                });
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-feedback';
                errorDiv.innerHTML = `
                    <div class="modal-fade-in bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative shadow-lg" role="alert">
                        <strong class="font-bold">L·ªói!</strong>
                        <span class="block sm:inline">${message}</span>
                    </div>
                `;
                document.getElementById('ai-feedback-container').appendChild(errorDiv);
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 4000);
            }

            listenToData() {
                if (!userId) return;
                
                // Listen to accounts
                const accountsCollection = collection(db, `artifacts/${appId}/users/${userId}/accounts`);
                onSnapshot(accountsCollection, (snapshot) => {
                    let cashBalance = 0;
                    let bankBalance = 0;
                    snapshot.forEach(doc => {
                        if (doc.id === 'cash') cashBalance = doc.data().balance;
                        if (doc.id === 'bank') bankBalance = doc.data().balance;
                    });
                    cashBalanceEl.textContent = this.formatMoney(cashBalance);
                    bankBalanceEl.textContent = this.formatMoney(bankBalance);
                });

                // Listen to transactions
                const transactionsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                onSnapshot(transactionsQuery, (snapshot) => {
                    this.allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.allTransactions.sort((a, b) => {
                        const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                        const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                        return timeB - timeA;
                    });
                    this.renderDisplay();
                });
            }

            renderDisplay() {
                transactionsContainer.innerHTML = '';
                
                // 1. Apply filters
                let filteredTransactions = this.allTransactions;
                if (this.filters.date) {
                    filteredTransactions = this.allTransactions.filter(t => {
                        if (!t.createdAt) return false; // Ignore transactions being created
                        const tDate = t.createdAt.toDate().toISOString().split('T')[0];
                        return tDate === this.filters.date;
                    });
                } else if (this.filters.month) {
                    filteredTransactions = this.allTransactions.filter(t => {
                        if (!t.createdAt) return false; // Ignore transactions being created
                        const tMonth = t.createdAt.toDate().toISOString().slice(0, 7);
                        return tMonth === this.filters.month;
                    });
                }

                // 2. Apply pagination
                const totalPages = Math.ceil(filteredTransactions.length / this.transactionsPerPage) || 1;
                if(this.currentPage > totalPages) this.currentPage = totalPages;

                const startIndex = (this.currentPage - 1) * this.transactionsPerPage;
                const endIndex = startIndex + this.transactionsPerPage;
                const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);

                // 3. Render transactions
                if (paginatedTransactions.length === 0) {
                    transactionsContainer.appendChild(noTransactionsMsg);
                    noTransactionsMsg.classList.remove('hidden');
                    paginationControls.classList.add('hidden');
                } else {
                    noTransactionsMsg.classList.add('hidden');
                    paginationControls.classList.remove('hidden');
                    paginatedTransactions.forEach(transaction => {
                        const transactionEl = this.createTransactionElement(transaction);
                        transactionsContainer.appendChild(transactionEl);
                    });
                }
                
                // 4. Update pagination controls
                pageInfo.textContent = `Trang ${this.currentPage} / ${totalPages}`;
                prevPageBtn.disabled = this.currentPage === 1;
                nextPageBtn.disabled = this.currentPage === totalPages;
            }

            createTransactionElement(transaction) {
                const transactionEl = document.createElement('div');
                transactionEl.className = `flex items-center justify-between p-3 border-b border-gray-200 hover:bg-gray-50 rounded-lg mb-2`;
                
                // **FIX:** Check if createdAt exists before calling toDate()
                const displayDate = transaction.createdAt 
                    ? transaction.createdAt.toDate().toLocaleString('vi-VN') 
                    : 'ƒêang x·ª≠ l√Ω...';

                transactionEl.innerHTML = `
                    <div class="flex items-center gap-4 flex-grow">
                        <div class="text-3xl">${transaction.categoryIcon || '#Ô∏è‚É£'}</div>
                        <div class="flex-grow">
                            <p class="font-semibold">${transaction.description}</p>
                            <p class="text-sm text-gray-500">${displayDate}</p>
                        </div>
                    </div>
                    <div class="text-right mr-4">
                        <p class="font-bold text-lg ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${transaction.type === 'income' ? '+' : '-'}${this.formatMoney(transaction.amount)}
                        </p>
                        <p class="text-sm text-gray-500">${transaction.accountId === 'cash' ? 'üíµ Ti·ªÅn m·∫∑t' : 'üí≥ Ng√¢n h√†ng'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-action btn-edit" data-id="${transaction.id}" title="S·ª≠a">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="btn-action btn-delete" data-id="${transaction.id}" title="X√≥a">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `;
                
                // Add event listeners for edit/delete
                transactionEl.querySelector('.btn-edit').addEventListener('click', (e) => {
                    const transId = e.currentTarget.dataset.id;
                    const transData = this.allTransactions.find(t => t.id === transId);
                    this.transactionManager.processUserInput(null, transData);
                });

                transactionEl.querySelector('.btn-delete').addEventListener('click', async (e) => {
                    const transId = e.currentTarget.dataset.id;
                    const transData = this.allTransactions.find(t => t.id === transId);
                    const confirmed = await this.showConfirmation(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a giao d·ªãch: "${transData.description}" kh√¥ng?`);
                    if (confirmed) {
                        this.transactionManager.deleteTransaction(transId, transData);
                    }
                });

                return transactionEl;
            }

            formatMoney(amount) {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
            }
        }

        // --- Transaction Management Class ---
        class TransactionManager {
            constructor(app) {
                this.app = app; // Reference to the main app
                this.geminiAI = new GeminiAI();
            }

            async processUserInput(userInput, existingTransaction = null) {
                if (existingTransaction) {
                    // Editing existing transaction
                    const confirmation = await this.showConfirmationDialog(existingTransaction, true);
                    if (confirmation.confirmed) {
                        await this.updateTransaction(existingTransaction.id, existingTransaction, confirmation.data);
                    }
                } else {
                    // Creating new transaction
                    const aiAnalysis = await this.geminiAI.analyzeTransaction(userInput);
                    if (!aiAnalysis.success) throw new Error(aiAnalysis.error);
                    
                    const confirmation = await this.showConfirmationDialog(aiAnalysis.data, false);
                    if (confirmation.confirmed) {
                        const evaluation = await this.geminiAI.evaluateTransaction(confirmation.data);
                        await this.saveTransaction(confirmation.data, evaluation);
                    }
                }
            }
            
            getCategoryOptions(selectedCategoryIcon) {
                const categories = [
                    { icon: 'üçî', name: 'ƒê·ªì ƒÉn' }, { icon: 'üçπ', name: 'ƒê·ªì u·ªëng' }, { icon: 'ü•¶', name: 'ƒêi ch·ª£' },
                    { icon: 'üõµ', name: 'Giao th√¥ng' }, { icon: 'üè°', name: 'Nh√† c·ª≠a' }, { icon: 'üõç', name: 'Mua s·∫Øm' },
                    { icon: 'üéÆ', name: 'Gi·∫£i tr√≠' }, { icon: 'üéì', name: 'Gi√°o d·ª•c' }, { icon: 'ÔøΩ', name: 'S·ª©c kh·ªèe' },
                    { icon: 'üèñ', name: 'Du l·ªãch' }, { icon: 'üí∞', name: 'L∆∞∆°ng/Thu nh·∫≠p' }, { icon: 'üí∏', name: 'Kinh doanh' },
                    { icon: 'üéÅ', name: 'Qu√† t·∫∑ng' }, { icon: '#Ô∏è‚É£', name: 'Kh√°c' }
                ];
                return categories.map(cat => 
                    `<option value="${cat.icon}" ${selectedCategoryIcon === cat.icon ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                ).join('');
            }

            showConfirmationDialog(data, isEditing) {
                return new Promise((resolve) => {
                    const modalContainer = document.getElementById('modal-container');
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    
                    const modalData = {
                        type: data.type || 'expense',
                        amount: data.amount || 0,
                        description: data.description || '',
                        categoryIcon: data.categoryIcon || '#Ô∏è‚É£',
                        accountId: data.accountId || 'cash'
                    };

                    modal.innerHTML = `
                        <div class="modal-fade-in bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
                            <h3 class="text-2xl font-bold mb-4">${isEditing ? 'Ch·ªânh s·ª≠a giao d·ªãch' : 'X√°c nh·∫≠n th√¥ng tin'}</h3>
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label class="font-semibold text-gray-600 block mb-1">Lo·∫°i giao d·ªãch:</label>
                                    <select id="confirm-type" class="w-full p-3 border rounded-lg bg-gray-50">
                                        <option value="expense" ${modalData.type === 'expense' ? 'selected' : ''}>Chi ti√™u</option>
                                        <option value="income" ${modalData.type === 'income' ? 'selected' : ''}>Thu nh·∫≠p</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="font-semibold text-gray-600 block mb-1">S·ªë ti·ªÅn:</label>
                                    <input type="number" id="confirm-amount" value="${modalData.amount}" class="w-full p-3 border rounded-lg bg-gray-50">
                                </div>
                                <div class="form-group">
                                    <label class="font-semibold text-gray-600 block mb-1">M√¥ t·∫£:</label>
                                    <input type="text" id="confirm-description" value="${modalData.description}" class="w-full p-3 border rounded-lg bg-gray-50">
                                </div>
                                <div class="form-group">
                                    <label class="font-semibold text-gray-600 block mb-1">Danh m·ª•c:</label>
                                    <select id="confirm-category" class="w-full p-3 border rounded-lg bg-gray-50">
                                        ${this.getCategoryOptions(modalData.categoryIcon)}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="font-semibold text-gray-600 block mb-1">Ngu·ªìn ti·ªÅn:</label>
                                    <select id="confirm-account" class="w-full p-3 border rounded-lg bg-gray-50">
                                        <option value="cash" ${modalData.accountId === 'cash' ? 'selected' : ''}>üíµ Ti·ªÅn m·∫∑t</option>
                                        <option value="bank" ${modalData.accountId === 'bank' ? 'selected' : ''}>üí≥ Ng√¢n h√†ng</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button id="confirm-cancel" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">H·ªßy</button>
                                <button id="confirm-save" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">L∆∞u</button>
                            </div>
                        </div>
                    `;
                    modalContainer.appendChild(modal);

                    const closeModal = () => modalContainer.innerHTML = '';

                    document.getElementById('confirm-save').onclick = () => {
                        const finalData = {
                            type: document.getElementById('confirm-type').value,
                            amount: parseFloat(document.getElementById('confirm-amount').value) || 0,
                            description: document.getElementById('confirm-description').value,
                            categoryIcon: document.getElementById('confirm-category').value,
                            accountId: document.getElementById('confirm-account').value
                        };
                        closeModal();
                        resolve({ confirmed: true, data: finalData });
                    };

                    document.getElementById('confirm-cancel').onclick = () => {
                        closeModal();
                        resolve({ confirmed: false });
                    };
                });
            }

            async saveTransaction(transactionData, evaluation) {
                if (!userId) throw new Error("User not authenticated.");

                const transaction = {
                    ...transactionData,
                    userId: userId,
                    isNecessary: evaluation.isNecessary,
                    aiComment: evaluation.comment,
                    aiAdvice: evaluation.advice,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), transaction);
                await this.updateAccountBalance(transactionData.accountId, transactionData.amount, transactionData.type);
                this.showAIFeedback(evaluation);
            }

            async updateTransaction(id, oldData, newData) {
                if (!userId) throw new Error("User not authenticated.");
                const transactionRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                
                // Update Firestore document
                await updateDoc(transactionRef, {
                    ...newData,
                    updatedAt: serverTimestamp()
                });

                // Revert old balance
                const revertType = oldData.type === 'income' ? 'expense' : 'income';
                await this.updateAccountBalance(oldData.accountId, oldData.amount, revertType);

                // Apply new balance
                await this.updateAccountBalance(newData.accountId, newData.amount, newData.type);
            }

            async deleteTransaction(id, data) {
                 if (!userId) throw new Error("User not authenticated.");
                const transactionRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                
                await deleteDoc(transactionRef);
                
                // Revert balance change
                const revertType = data.type === 'income' ? 'expense' : 'income';
                await this.updateAccountBalance(data.accountId, data.amount, revertType);
            }

            async updateAccountBalance(accountId, amount, type) {
                if (!userId) throw new Error("User not authenticated.");
                
                const accountRef = doc(db, `artifacts/${appId}/users/${userId}/accounts`, accountId);
                const accountSnap = await getDoc(accountRef);

                let currentBalance = 0;
                if (accountSnap.exists()) {
                    currentBalance = accountSnap.data().balance;
                } else {
                    await setDoc(accountRef, {
                        name: accountId === 'cash' ? 'Ti·ªÅn m·∫∑t' : 'Ng√¢n h√†ng',
                        balance: 0,
                        userId: userId,
                        createdAt: serverTimestamp()
                    });
                }

                const newBalance = type === 'income' ? currentBalance + amount : currentBalance - amount;
                await updateDoc(accountRef, {
                    balance: newBalance,
                    updatedAt: serverTimestamp()
                });
            }

            showAIFeedback(evaluation) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'ai-feedback';
                const isPositive = evaluation.isNecessary;
                const bgColor = isPositive ? 'bg-green-100 border-green-400 text-green-700' : 'bg-yellow-100 border-yellow-400 text-yellow-700';
                
                feedbackDiv.innerHTML = `
                    <div class="modal-fade-in ${bgColor} border px-4 py-3 rounded-lg relative shadow-lg max-w-sm">
                        <h4 class="font-bold">${isPositive ? '‚úÖ Giao d·ªãch h·ª£p l√Ω' : '‚ö†Ô∏è C·∫ßn c√¢n nh·∫Øc'}</h4>
                        <p>${evaluation.comment}</p>
                        ${evaluation.advice ? `<p class="mt-2"><strong>L·ªùi khuy√™n:</strong> ${evaluation.advice}</p>` : ''}
                    </div>
                `;
                feedbackContainer.appendChild(feedbackDiv);

                setTimeout(() => {
                    if (feedbackDiv.parentNode) {
                        feedbackDiv.parentNode.removeChild(feedbackDiv);
                    }
                }, 7000);
            }
        }

        // --- Gemini AI Class ---
        class GeminiAI {
            constructor() {
                this.apiKey = "AIzaSyAnqAiCb-2A1x-CBRDiHXZEi8hEyHGVnMo"; // API Key updated
                this.apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${this.apiKey}`;
            }

            async analyzeTransaction(userInput) {
                const prompt = `
                Ph√¢n t√≠ch chu·ªói vƒÉn b·∫£n giao d·ªãch t√†i ch√≠nh sau ƒë√¢y v√† tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.
                VƒÉn b·∫£n: "${userInput}"

                Quy t·∫Øc:
                1.  X√°c ƒë·ªãnh lo·∫°i giao d·ªãch: "income" (thu nh·∫≠p) ho·∫∑c "expense" (chi ti√™u).
                2.  Tr√≠ch xu·∫•t s·ªë ti·ªÅn (ch·ªâ tr·∫£ v·ªÅ s·ªë, kh√¥ng c√≥ k√Ω t·ª± ti·ªÅn t·ªá). N·∫øu kh√¥ng r√µ, m·∫∑c ƒë·ªãnh l√† 0.
                3.  T·∫°o m·ªôt m√¥ t·∫£ ng·∫Øn g·ªçn.
                4.  Ch·ªçn m·ªôt emoji ph√π h·ª£p nh·∫•t t·ª´ danh s√°ch sau cho danh m·ª•c: üçî, üçπ, ü•¶, üõµ, üè°, üõç, üéÆ, üéì, üè•, üèñ, üí∞, üí∏, üéÅ, #Ô∏è‚É£. N·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c, d√πng '#Ô∏è‚É£'.
                5.  X√°c ƒë·ªãnh ngu·ªìn ti·ªÅn: "cash" (ti·ªÅn m·∫∑t) ho·∫∑c "bank" (ng√¢n h√†ng/chuy·ªÉn kho·∫£n). N·∫øu kh√¥ng r√µ, m·∫∑c ƒë·ªãnh l√† "cash".

                Ch·ªâ tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng JSON, kh√¥ng c√≥ vƒÉn b·∫£n gi·∫£i th√≠ch n√†o kh√°c.

                Format JSON ƒë·∫ßu ra:
                {
                    "type": "expense",
                    "amount": 50000,
                    "description": "ƒÇn t·ªëi",
                    "categoryIcon": "üçî",
                    "account": "cash"
                }
                `;
                
                try {
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("API Error Body:", errorBody);
                        throw new Error(`API call failed with status: ${response.status}. ${errorBody.error?.message || ''}`);
                    }
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    const cleanJsonString = text.replace(/```json|```/g, '').trim();
                    const parsedData = JSON.parse(cleanJsonString);
                    return { success: true, data: parsedData };
                } catch (error) {
                    console.error('Gemini AI Error:', error);
                    return { success: false, error: 'Kh√¥ng th·ªÉ ph√¢n t√≠ch giao d·ªãch b·∫±ng AI. Vui l√≤ng ki·ªÉm tra API Key v√† th·ª≠ l·∫°i.' };
                }
            }

            async evaluateTransaction(transactionData) {
                const prompt = `
                ƒê√°nh gi√° giao d·ªãch t√†i ch√≠nh sau v√† ƒë∆∞a ra nh·∫≠n x√©t.
                - Lo·∫°i: ${transactionData.type === 'income' ? 'Thu nh·∫≠p' : 'Chi ti√™u'}
                - S·ªë ti·ªÅn: ${transactionData.amount} VND
                - M√¥ t·∫£: ${transactionData.description}
                - Danh m·ª•c: ${transactionData.categoryIcon}
                
                Quy t·∫Øc:
                1.  X√°c ƒë·ªãnh xem giao d·ªãch c√≥ c·∫ßn thi·∫øt kh√¥ng ("isNecessary": true/false). C√°c kho·∫£n chi cho ƒÉn u·ªëng, ƒëi l·∫°i, nh√† c·ª≠a, s·ª©c kh·ªèe th∆∞·ªùng l√† c·∫ßn thi·∫øt. C√°c kho·∫£n gi·∫£i tr√≠, mua s·∫Øm ƒë·∫Øt ti·ªÅn c√≥ th·ªÉ kh√¥ng. Thu nh·∫≠p lu√¥n l√† c·∫ßn thi·∫øt.
                2.  Vi·∫øt m·ªôt nh·∫≠n x√©t ng·∫Øn g·ªçn, th√¢n thi·ªán ("comment").
                3.  N·∫øu l√† chi ti√™u kh√¥ng c·∫ßn thi·∫øt ho·∫∑c c√≥ th·ªÉ t·ªëi ∆∞u, ƒë∆∞a ra m·ªôt l·ªùi khuy√™n ng·∫Øn ("advice"). N·∫øu kh√¥ng, ƒë·ªÉ tr·ªëng.

                Ch·ªâ tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng JSON.
                
                Format JSON:
                {
                    "isNecessary": true,
                    "comment": "M·ªôt kho·∫£n chi ti√™u h·ª£p l√Ω cho b·ªØa ƒÉn.",
                    "advice": ""
                }
                `;

                try {
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                     if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    const cleanJsonString = text.replace(/```json|```/g, '').trim();
                    return JSON.parse(cleanJsonString);
                } catch (error) {
                    console.error('Gemini Evaluation Error:', error);
                    return { isNecessary: true, comment: "ƒê√£ l∆∞u giao d·ªãch th√†nh c√¥ng.", advice: "" };
                }
            }
        }

        // --- Voice Input Class ---
        class VoiceInputManager {
            constructor() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn("Speech Recognition not supported in this browser.");
                    voiceBtn.style.display = 'none';
                    return;
                }
                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'vi-VN';
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
            }

            startListening() {
                return new Promise((resolve, reject) => {
                    if (!this.recognition) {
                        reject("Speech Recognition not supported.");
                        return;
                    }
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        resolve(transcript);
                    };
                    this.recognition.onerror = (event) => {
                        reject(event.error);
                    };
                    this.recognition.start();
                });
            }
        }
        
        // --- Authentication and App Start ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
                userIdDisplay.textContent = `User ID: ${userId}`;
                const appInstance = new FinanceApp();
                appInstance.listenToData();
            } else {
                console.log("User is signed out. Attempting to sign in.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.body.innerHTML = `<div class="text-white text-center p-8">L·ªói x√°c th·ª±c. Kh√¥ng th·ªÉ t·∫£i ·ª©ng d·ª•ng.</div>`;
                }
            }
        });

    </script>
</body>
</html>